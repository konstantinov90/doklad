Всем привет! Меня зовут Саша, я занимаюсь разработкой интерфейсов в директе.

Я расскажу вам про то, как мы работаем с переводами, с какими проблемами столкнулись и как 

Наш сервис мы разрабатываем для пользователей из разных стран, поэтому интерфейс у нас доступен на трех языках, включая русский.

Для работы с переводами мы используем стандартные инструменты:
- одна из наших яндексовых библиотек интернационализации (почему "одна из" - потому что у нас есть старый и новый интерфейс, написанные на разных технологиях)
- у нас есть проект в танкере (все знакомы с танкером?), который для нас является "источником истины" про переводы
- для синхронизации с танкером мы используем утилиту tanker-kit
- у нас есть скрипты для автоматической синхронизации с танкером, которые выполняются по ночам

У нас (был) стандартный процесс:
- разработчик получает какую-то задачу, для которой в своей ветке добавляет новые фразы в код проекта
- в какой-то момент он вливает свой пул-реквест в транк вместе с новыми фразами
- (ночью) транк синхронизируется с мастером танкера, после чего переводчики могут брать новые фразы в работу
- переводы переводятся
- (еще одной ночью) мастер танкера синхронизируется с транком, после чего переводы новых фраз попадают в код
- и цикл завершается

Вот как это выглядит на диаграмме:
Итак, переводы в транке, релиз собран, все хорошо. Можно выдавать роли пользователям и пиарить свою новую фичу, да?
Не совсем. Это идеальная картина, но давайте посмотрим, как это обычно происходит на практике:

Ну ладно, но после второго релиза уже можно пиарить? Эээээмм, тоже нет, потому что последний кусочек попал в мастер после синхронизации. Ок, ну после третьего-то релиза можно? Если представить, что все части перевода попали в нашу диаграмму - то можете пиарить свою фичу.

Но что у нас в целом с интерфейсом? Когда мы можем сказать, что он полностью переведен, что нашим не русскоязычным пользователям доступен весь функционал? При условии активной разработки, к сожалению, мы можем достоверно сказать только "никогда".

Вот пример того, что могут увидеть англоязычные пользователи на одной из страниц в продакшене директа.

Итак, какие у нас проблемы:
- в продакшене гуляют непереведенные куски интерфейса
- в условиях активной разработки можно гарантировать, что нерусскоязычным пользователям интерфейс не полностью доступен
- трудно контролировать и прогнозировать процесс перевода конкретных частей функциональности (конкретных задач), так как все непереведенные фразы живут в мастере танкера одной кучей и могут переводиться в любом порядке


## Как же мы будем решать эту проблему?

Чтобы контролировать процесс переводов нам нужно научиться выделять из общей кучи конкретные фразы, поменяашиеся в конкретной задаче. Зная список фраз мы сможем проверить наличие переводов в танкере, и когда все нужные нам фразы будут переведены, дождаться очередного цикла синхронизации. Тогда мы сможем быть уверены, что интерсующая нас функциональность находится в транке с переводами

Итак, как же мы можем получить список фраз, поменяашихся в задаче? 

Сначала мы подумали, что нам поможет github, а точнее git, он же знает все, что поменялось в пул-реквесте. Достаточно выгрузить diff пул-реквеста и отфильтровать по файлам с переводами. Но тут вы скажете, что не во всех проектах переводы лежат в отдельных файлах, кто-то их размещает прямо в коде, и парсит их танкер-китом, да и парсеры у всех разные. Более того, многие проекты живут не на гитхабе, в них нужно будет учитывать специфику других vcs.

Но ведь у нас настроен парсер tanker-kit'а. Правда, tanker-kit не может парсить diff. Да и мы работаем с распаршенными фразами уже в танкере. Но ведь танкер может работать с ветками!

Мы посмотрели на API танкера и увидели, что танкер умеет вычислять diff между своими ветками, это же то, что нам нужно

Значит, чтобы получить список поменявшихся фраз мы можем
- для конкретной задачи создать ветку в танкере
- синхронизировать фразы в задаче с этой веткой
- с помощью API танкера вычислить diff ветки с мастером

И вуаля, у нас есть готовый список фраз. После влития пул-реквеста мы можем по списку проверять переводы фраз и при необходимости просить переводчиков побыстрее взять нужные нам фразы

Но стоять! Пока мы получали список фраз, в качестве побочного эффекта мы получили ветку в танкере с этими самыми фразами. Посмотрим еще раз на API танкера. Так и есть, танкер позволяет мержить свои ветки. Тогда спрашивается, зачем ждать, пока вольется пул-реквест, если мы можем попросить переводчиков перевести фразы прямо сейчас? 

Это значит, что перевод может быть готов уже к моменту мержа пул-реквеста в транк, более того, переводы будут готовы как в танкере, так и уже в коде задачи.

А это значит, что мы больше не завязаны на ночную синхронизацию с танкером и мы можем гарантировать, что нужные фразы будут переведены в полном объеме

Остается только создать в стартреке тикет на перевод со списком фраз и установить нужный дедлайн

Таким образом мы пришли к новому процессу:

- разработчки добавляет новые фразы в своей dev-ветке
- когда активная разработка завершена, разработчки создает ветку в танкере и синхронизируется с ней
- получает список фраз, требущих перевод, как diff между своей веткой и мастером танкера
- создает тикет на перевод с этим списком фраз
- переводчики переводят, тестировщики тестируют
- когда переводы готовы, разработчик снова синхронизируется с веткой в танкере, после чего все фразы в пул-реквесте уже переведены
- мержит свой пул-реквест в транк и мержит ветку в танкере в мастер
- задача полностью готова к релизу
